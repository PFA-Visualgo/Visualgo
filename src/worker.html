<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PyScript Next</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

</head>
<body>
<script type="pyodide">
            from js import Promise, document
            from polyscript import XWorker

            deferred = Promise.withResolvers()

            def handle_increment(event):
                global deferred
                button = document.getElementById("incr")
                button.disabled = True
                deferred.resolve()
                deferred = Promise.withResolvers()

            # allows the worker to ask something as placeholder
            # resolves the returning on micropython-click event
            # non-blocking this thread, keeping the worker in idle
            # until such promise is not resolved
            def handle_cpt(newVal):
              button = document.getElementById("incr")
              button.disabled = False
              cptDiv = document.getElementById("cpt")
              cptDiv.textContent = str(newVal)
              return deferred.promise

            w = XWorker('./worker.py')

            # provide a synchronous input callback
            # to the polyscript's xworker utility
            w.sync.count = handle_cpt
        </script>
        <button pyodide-click="handle_increment" disabled id="incr">Increment</button>
        <div id="cpt">loading...</div>

<!-- this is only to test the non-blocking behavior -->
        <script>
          addEventListener('DOMContentLoaded', () => {
            const div = document.body.appendChild(
              document.createElement('div')
            );
            (function monitor() {
              const date = new Date;
              div.textContent = `${date.getSeconds()}.${date.getMilliseconds()}`;
              requestAnimationFrame(monitor);
            }());
          });
        </script>
</body>
</html>
